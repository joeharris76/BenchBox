name: Release

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      test_pypi:
        description: 'Publish to Test PyPI instead of PyPI'
        required: false
        default: false
        type: boolean

jobs:
  # Wait for CI workflows (Tests + Lint) to pass before building
  check-ci-passed:
    runs-on: ubuntu-latest
    steps:
      - name: Verify CI workflows passed for this commit
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const sha = context.sha;

            console.log(`Checking CI workflows for commit: ${sha}`);

            const requiredWorkflows = ['test.yml', 'lint.yml'];
            const maxWait = 15 * 60 * 1000;  // 15 minutes
            const pollInterval = 30 * 1000;  // 30 seconds
            let waited = 0;

            while (waited < maxWait) {
              const results = await Promise.all(
                requiredWorkflows.map(async (workflow) => {
                  const runs = await github.rest.actions.listWorkflowRuns({
                    owner, repo,
                    workflow_id: workflow,
                    head_sha: sha,
                  });
                  return { workflow, run: runs.data.workflow_runs[0] };
                })
              );

              let allComplete = true;
              let anyFailed = false;
              let failedWorkflow = null;

              for (const { workflow, run } of results) {
                if (!run) {
                  console.log(`  ${workflow}: not found, waiting...`);
                  allComplete = false;
                } else if (run.status !== 'completed') {
                  console.log(`  ${workflow}: ${run.status}...`);
                  allComplete = false;
                } else if (run.conclusion !== 'success') {
                  console.log(`  ${workflow}: ${run.conclusion}`);
                  anyFailed = true;
                  failedWorkflow = { workflow, run };
                } else {
                  console.log(`  ${workflow}: passed`);
                }
              }

              if (anyFailed) {
                core.setFailed(`${failedWorkflow.workflow} ${failedWorkflow.run.conclusion}. See: ${failedWorkflow.run.html_url}`);
                return;
              }

              if (allComplete) {
                console.log(`\nAll CI workflows passed for ${sha}`);
                return;
              }

              console.log(`\nWaiting... (${Math.round(waited/1000)}s elapsed)\n`);
              await new Promise(r => setTimeout(r, pollInterval));
              waited += pollInterval;
            }

            core.setFailed(`Timed out waiting for CI workflows after ${maxWait/60000} minutes`);

  build:
    needs: check-ci-passed
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Extract version
        id: version
        run: |
          version=$(grep -E '^version = ' pyproject.toml | sed -E 's/version = "(.*)"/\1/')
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Build package with reproducible timestamp
        run: |
          # Use commit timestamp for reproducible builds
          # Anyone building from the same commit gets identical artifacts
          export SOURCE_DATE_EPOCH=$(git log -1 --format=%ct)
          echo "Building with SOURCE_DATE_EPOCH=$SOURCE_DATE_EPOCH"
          uv build

      - name: Check package
        run: uvx twine check dist/*

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-dist
          path: dist/
          retention-days: 30

  publish:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.test_pypi == 'true' && 'test-pypi' || 'pypi' }}
      url: ${{ github.event.inputs.test_pypi == 'true' && 'https://test.pypi.org/p/benchbox' || 'https://pypi.org/p/benchbox' }}
    permissions:
      id-token: write  # Required for trusted publishing (OIDC)
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-dist
          path: dist/

      - name: Publish to Test PyPI
        if: github.event.inputs.test_pypi == 'true'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          skip-existing: true

      - name: Publish to PyPI
        if: github.event.inputs.test_pypi != 'true'
        uses: pypa/gh-action-pypi-publish@release/v1

  # Verify installation works across platforms after publishing
  test-installation:
    needs: publish
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.10', '3.12', '3.13']
        exclude:
          # Reduce matrix size - test latest Python only on Linux
          - os: windows-latest
            python-version: '3.13'
          - os: macos-latest
            python-version: '3.13'
    steps:
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Wait for package availability
        shell: bash
        run: sleep 60

      - name: Test installation from PyPI
        if: github.event.inputs.test_pypi != 'true'
        run: |
          pip install benchbox
          python -c "import benchbox; print(f'BenchBox {benchbox.__version__} installed successfully')"
          benchbox --help

      - name: Test installation from Test PyPI
        if: github.event.inputs.test_pypi == 'true'
        run: |
          pip install -i https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ benchbox
          python -c "import benchbox; print(f'BenchBox {benchbox.__version__} installed successfully')"
          benchbox --help

  # Delete old workflow artifacts to prevent confusion
  cleanup-artifacts:
    needs: test-installation
    runs-on: ubuntu-latest
    permissions:
      actions: write
    steps:
      - name: Delete old release artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;

            // List artifacts older than 7 days with 'release-dist' or 'dist' name
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner,
              repo,
              per_page: 100,
            });

            const now = new Date();
            const sevenDaysAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);

            for (const artifact of artifacts.data.artifacts) {
              const createdAt = new Date(artifact.created_at);
              // Delete old dist artifacts to prevent confusion
              if (createdAt < sevenDaysAgo &&
                  (artifact.name === 'dist' || artifact.name === 'release-dist' || artifact.name === 'test-dist')) {
                console.log(`Deleting old artifact: ${artifact.name} (${artifact.id}) from ${artifact.created_at}`);
                await github.rest.actions.deleteArtifact({
                  owner,
                  repo,
                  artifact_id: artifact.id,
                });
              }
            }
